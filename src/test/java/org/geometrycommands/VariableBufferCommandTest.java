package org.geometrycommands;

import org.geometrycommands.VariableBufferCommand.VariableBufferOptions;
import org.junit.Test;

import java.io.Reader;
import java.io.StringReader;
import java.io.StringWriter;
import java.util.Arrays;

import static org.junit.Assert.assertEquals;

/**
 * The VariableBufferCommand UnitTest
 * @author Jared Erickson
 */
public class VariableBufferCommandTest extends BaseTest {

    @Test 
    public void execute() throws Exception {
        
        String inputGeometry = "LINESTRING (0 1, 2 3, 4 5)";
        VariableBufferOptions options = new VariableBufferOptions();
        options.setGeometry(inputGeometry);
        options.setDistances(Arrays.asList(5.0, 10.0));

        Reader reader = new StringReader(inputGeometry);
        StringWriter writer = new StringWriter();
        
        VariableBufferCommand command = new VariableBufferCommand();
        command.execute(options, reader, writer);
        assertEquals("POLYGON ((-4.778594569415369 -0.4714054305846311, -5.167891854123054 0.7928918541230532, " +
                "-5.557189138830738 2.0571891388307377, -5.807852804032304 3.0490967798387163, -6 5, " +
                "-5.807852804032304 6.950903220161286, -5.238795325112868 8.8268343236509, " +
                "-4.314696123025453 10.555702330196022, -3.0710678118654746 12.071067811865476, " +
                "-1.55570233019602 13.314696123025453, 0.173165676349103 14.238795325112868, " +
                "2.049096779838718 14.807852804032304, 4 15, 5.950903220161283 14.807852804032304, " +
                "7.826834323650898 14.238795325112868, 9.555702330196024 13.314696123025453, " +
                "11.071067811865476 12.071067811865476, 12.314696123025453 10.555702330196022, " +
                "13.238795325112868 8.826834323650898, 13.807852804032304 6.950903220161282, 14 5, " +
                "13.807852804032304 3.0490967798387176, 13.238795325112868 1.173165676349102, " +
                "12.314696123025453 -0.5557023301960218, 11.071067811865476 -2.0710678118654746, " +
                "9.555702330196024 -3.3146961230254526, 7.826834323650898 -4.238795325112868, " +
                "5.950903220161283 -4.807852804032304, 4 -5, 1.0571891388307377 -4.557189138830738, " +
                "-0.2071081458769468 -4.167891854123054, -1.4714054305846311 -3.778594569415369, " +
                "-0.975451610080641 -3.903926402016152, -1.9134171618254485 -3.619397662556434, " +
                "-2.77785116509801 -3.1573480615127263, -3.5355339059327373 -2.5355339059327378, " +
                "-4.157348061512726 -1.7778511650980109, -4.778594569415369 -0.4714054305846311), " +
                "(-0.2071081458769468 -4.167891854123054, 0.5368225848790384 -4.355889603024228, " +
                "0.0393106141249076 -4.20497099664101, " +
                "-0.2071081458769468 -4.167891854123054))", writer.getBuffer().toString());
    }

    @Test
    public void run() throws Exception {
        // Geometry from options
        String result = runApp(new String[]{
                "variablebuffer",
                "-g", "LINESTRING (0 1, 2 3, 4 5, 6 7, 8 9)",
                "-d", "5",
                "-d", "6",
                "-d", "12"
        }, null);
        assertEquals("POLYGON ((-3.9275624054901486 4.094229072156818, -3.251678721131326 4.952140780458855, " +
                "-3.769423364838765 6.65891613580646, -4 9, -3.769423364838765 11.341083864193543, " +
                "-3.08655439013544 13.592201188381079, -1.9776353476305442 15.666842796235226, " +
                "-0.4852813742385695 17.48528137423857, 1.3331572037647765 18.977635347630546, " +
                "3.407798811618923 20.08655439013544, 5.658916135806462 20.769423364838765, 8 21, " +
                "10.34108386419354 20.769423364838765, 12.592201188381079 20.08655439013544, " +
                "14.666842796235228 18.977635347630542, 16.48528137423857 17.485281374238568, " +
                "17.977635347630542 15.666842796235226, 19.08655439013544 13.592201188381077, " +
                "19.769423364838765 11.34108386419354, 20 9, 19.769423364838765 6.6589161358064555, " +
                "19.08655439013544 4.407798811618916, 17.977635347630542 2.333157203764774, " +
                "16.485281374238568 0.5147186257614287, 14.666842796235223 -0.9776353476305459, " +
                "12.592201188381079 -2.08655439013544, 10.34108386419354 -2.769423364838765, 8 -3, " +
                "5.6589161358064555 -2.7694233648387634, 3.9521407804588553 -2.2516787211313254, " +
                "3.0942290721568178 -2.9275624054901486, 2.777851165098009 -3.157348061512727, " +
                "1.91341716182545 -3.619397662556433, 0.9754516100806415 -3.903926402016152, 0 -4, " +
                "-0.9754516100806433 -3.9039264020161513, -1.9134171618254516 -3.619397662556432, " +
                "-2.777851165098011 -3.1573480615127263, -3.5355339059327386 -2.5355339059327373, " +
                "-4.157348061512727 -1.77785116509801, -4.619397662556434 -0.9134171618254483, " +
                "-4.903926402016152 0.0245483899193581, -5 1, -4.903926402016152 1.975451610080643, " +
                "-4.619397662556434 2.9134171618254494, -4.157348061512726 3.777851165098011, " +
                "-3.9275624054901486 4.094229072156818))", result);

        // Geometry from input stream
        result = runApp(new String[]{
                "variablebuffer",
                "-d", "5",
                "-d", "7",
                "-d", "10",
                "-d", "11",
                "-d", "20",
        }, "LINESTRING (0 1, 2 3, 4 5, 6 7, 8 9)");
        assertEquals("POLYGON ((28 9, 27.615705608064605 5.0981935596774255, 26.47759065022573 1.3463313526981917, " +
                "24.629392246050905 -2.1114046603920436, 22.142135623730947 -5.142135623730955, " +
                "19.111404660392036 -7.629392246050909, 15.6536686473018 -9.477590650225732, " +
                "11.901806440322567 -10.615705608064609, 8 -11, 4.098193559677426 -10.615705608064605, " +
                "0.3463313526981935 -9.477590650225729, -3.1114046603920436 -7.629392246050905, " +
                "-6.142135623730955 -5.142135623730949, -8.629392246050909 -2.11140466039204, " +
                "-10.477590650225736 1.3463313526982068, -11.615705608064609 5.098193559677433, " +
                "-12 9, -11.615705608064609 12.901806440322572, -10.477590650225736 16.6536686473018, " +
                "-8.629392246050905 20.111404660392044, -6.142135623730949 23.14213562373095, " +
                "-3.11140466039204 25.629392246050905, 0.3463313526982059 27.477590650225736, " +
                "4.098193559677436 28.61570560806461, 8 29, 11.901806440322567 28.61570560806461, " +
                "15.653668647301796 27.477590650225736, 19.111404660392047 25.629392246050905, " +
                "22.14213562373095 23.14213562373095, 24.629392246050905 20.111404660392044, " +
                "26.477590650225736 16.653668647301796, 27.61570560806461 12.901806440322565, 28 9))", result);
    }
}
